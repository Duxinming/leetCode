<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    行数：<input id="row" />
    列数：<input id="col" />
    炸弹数：<input id="bombNum" />
    <button onclick="reset()">重置</button>
    <div id="board"></div>
    </div>
</body>
<script src="./updateBoard.js"></script>
<script>
    function randomSortArray (arr) {
        var len = arr.length;
        //首先从最大的数开始遍历，之后递减
        for (var i = len - 1; i >= 0; i--) {
            var randomIndex = Math.floor(Math.random() * (i + 1));  //随机索引值randomIndex是从0-arr.length中随机抽取的，因为Math.floor()方法是向下取整的，所以这里是i+1
            //下面三句相当于把从数组中随机抽取到的值与当前遍历的值互换位置
            var temp = arr[randomIndex];
            arr[randomIndex] = arr[i];
            arr[i] = temp;
        }
        //每一次的遍历都相当于把从数组中随机抽取（不重复）的一个元素放到数组的最后面
        return arr;
    }
    function sliceArray (array, size) {
        var result = [];
        for (var x = 0; x < Math.ceil(array.length / size); x++) {
            var start = x * size;
            var end = start + size;
            result.push(array.slice(start, end));
        }
        return result;
    }
    class Board {
        element = null
        itemWidth = 50
        w = 3
        h = 3
        nums = 1
        boardList = ['E', 'M']
        arr = []
        status = {
            isWin: false,
            isLose: false,
            isStart: false
        }
        constructor(element, w = 3, h = 3, nums = 1) {
            document.oncontextmenu = function (event) {
                if (event.target.parentNode.parentNode.id === 'total') {
                    event.preventDefault();
                }
            };
            this.element = element
            this.w = w
            this.h = h
            this.nums = nums
            debugger
            const array = randomSortArray([...new Array(this.w * this.h - this.nums).fill(0), ...new Array(this.nums).fill(1)])
            const sliceArr = sliceArray(array, this.w)
            let total = document.createElement('div')
            total.id = 'total'
            element.appendChild(total)
            for (var i = 0; i < this.h; i++) {
                let rowDiv = document.createElement('div')
                rowDiv.id = i + 1
                rowDiv.className = 'row'
                rowDiv.style.width = `${this.w * this.itemWidth}px`
                for (var j = 0; j < this.w; j++) {
                    let itemDiv = document.createElement('div')
                    itemDiv.id = `${i + 1}-${j + 1}`
                    itemDiv.className = 'item'
                    itemDiv.onmousedown = (e) => {
                        e.stopPropagation()
                        if (this.status.isLose || this.status.isWin) {
                            alert('游戏结束，请重新开始')
                            return
                        } else {
                            this.status.isStart = true
                            if (e.button === 0) {
                                this.click(itemDiv.id)
                            } else if (e.button === 2) {
                                this.rightClick(itemDiv.id)
                            }
                        }

                    }
                    rowDiv.appendChild(itemDiv)
                    sliceArr[i][j] = sliceArr[i][j] ? this.boardList[1] : this.boardList[0]
                }
                total.appendChild(rowDiv)
            }
            this.arr = sliceArr
            this.updated()
        }
        click (id) {
            let item = document.getElementById(id)
            item.style.backgroundColor = ''
            const [x, y] = id.split('-')
            let clickArr = [Number(x) - 1, Number(y) - 1]
            this.arr = updateBoard(this.arr, clickArr)
            this.updated()
            if (this.arr[Number(x) - 1][Number(y) - 1] === 'X') {
                this.status.isLose = true
                alert('你输了')
                return
            }
            this.canWin()
        }
        rightClick (id) {
            const [x, y] = id.split('-')
            let item = document.getElementById(id)
            if (item.innerHTML === '') {
                item.style.backgroundColor = item.style.backgroundColor === 'red' ? '' : 'red'
                this.updated()
            }
            this.canWin()
        }
        updated () {
            for (var i = 0; i < this.h; i++) {
                for (var j = 0; j < this.w; j++) {
                    let div = document.getElementById(`${i + 1}-${j + 1}`);
                    if (div.style.backgroundColor === "red") {
                        continue
                    }
                    if (this.arr[i][j] === "M") {
                    } else if (this.arr[i][j] === "B") {
                        div.style.backgroundColor = "gray"
                    } else if (this.arr[i][j] === "X") {
                        div.style.color = 'red'
                        div.style.fontWeight = 'bold'
                    } else {
                        div.style.color = 'blue'
                        div.style.fontWeight = 'bold'
                    }
                    div.innerHTML = /[0-9]/.test(this.arr[i][j]) ? this.arr[i][j] : ''
                }
            }
        }
        canWin () {
            let arr = this.arr.flat()
            let num = arr.filter(item => item !== 'E' && item !== "M").length
            if (num === this.w * this.h - this.nums) {
                this.status.isWin = true
                alert('你赢了')
            }
        }
        distory () {
            this.arr = []
            this.status = {
                isWin: false,
                isLose: false,
                isStart: false
            }
            let total = document.getElementById('total')
            this.element.removeChild(total)
        }
    }
    let board = new Board(document.getElementById('board'));
    function reset () {
        board.distory()
        let w = document.getElementById('row').value;
        let h = document.getElementById('col').value;
        let nums = document.getElementById('bombNum').value;
        if (!testNum(w) || !testNum(h) || !testNum(nums)) {
            alert('输入不合法')
            return
        } else {
            board = new Board(document.getElementById('board'), Number(w), Number(h), Number(nums));
        }
    }
    function testNum (e) {
        return /[0-9]/.test(e)
    }
</script>

<style type="text/css">
    .row {
        display: flex;
        flex-direction: row;
        border: 1px solid #000;
        box-sizing: border-box;
    }

    .item {
        width: 50px;
        height: 50px;
        border: 1px solid #000;
        box-sizing: border-box;
        text-align: center;
        line-height: 50px;
    }
</style>

</html>